# Настройка Telegram бота для Production

## Автоматический запуск

Бот автоматически запускается вместе с Django при старте приложения через `apps.main.apps.MainConfig.ready()`.

## Токен бота

Токен берется из файла `.env` через переменную окружения `TELEGRAM_BOT_TOKEN`.

### Добавление токена на сервере

1. **Отредактируйте файл `.env` в корне проекта:**
   ```env
   TELEGRAM_BOT_TOKEN=8579619332:AAG-ADquy2sin1eYHOZPVB5FQDrpolHCnWI
   ```

2. **Или добавьте переменную окружения в системе:**
   ```bash
   export TELEGRAM_BOT_TOKEN=8579619332:AAG-ADquy2sin1eYHOZPVB5FQDrpolHCnWI
   ```

3. **Для production (systemd/supervisor):**
   Добавьте в конфигурацию сервиса:
   ```ini
   Environment="TELEGRAM_BOT_TOKEN=8579619332:AAG-ADquy2sin1eYHOZPVB5FQDrpolHCnWI"
   ```

## Проверка работы

После запуска Django бот автоматически:
1. Проверит наличие токена в базе данных
2. Запустится в отдельном потоке
3. Начнет обрабатывать команду `/start` от пользователей
4. Будет отправлять уведомления о новых заявках

## Логи

Все события бота логируются через `loguru`:
- Успешная регистрация чатов
- Ошибки отправки сообщений
- Критические ошибки с автоматическим перезапуском

Логи можно найти в папке `logs/` (если настроено логирование в файлы).

## Управление чатами

В админ-панели Django в разделе **Telegram чаты** можно:
- Просмотреть все зарегистрированные чаты
- Включить/отключить уведомления для конкретного чата (поле `is_active`)

## Регистрация руководителей

1. Руководитель находит бота в Telegram
2. Отправляет команду `/start`
3. Бот автоматически сохраняет chat_id и подтверждает подписку

## Устранение проблем

### Бот не запускается

1. Проверьте логи Django: `logs/django.log` или консоль
2. Убедитесь, что токен добавлен в `.env` файл как `TELEGRAM_BOT_TOKEN`
3. Проверьте, что приложение `apps.main` в `INSTALLED_APPS`
4. Убедитесь, что файл `.env` находится в корне проекта

### Уведомления не приходят

1. Проверьте, что есть активные чаты (`is_active=True`) в админке
2. Убедитесь, что бот запущен (проверьте логи)
3. Проверьте, что токен правильный

### Бот перезапускается

Бот автоматически перезапускается при критических ошибках через 30 секунд. Проверьте логи для выявления проблемы.

## Production рекомендации

Для production рекомендуется:
1. Использовать supervisor или systemd для управления процессами Django
2. Настроить мониторинг логов
3. Регулярно проверять работу бота

Бот работает как daemon-поток, поэтому не блокирует основной процесс Django и автоматически завершается при остановке приложения.
